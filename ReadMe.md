# csvsc

csvscは、CSV/TSVファイルを加工するためのコマンドラインツールです。設定ファイルに基づいて、ファイルのフィルタリング、列の追加、出力形式の変更などを行うことができます。

## 特徴

-   **設定ファイルベース:** JSON形式の設定ファイルで、入力ディレクトリ、出力ディレクトリ、ファイル名、エンコーディング、列の操作、フィルタリング条件などを指定できます。
-   **CSV/TSV対応:** 入力ファイルとしてCSVとTSVの両方をサポートします。
-   **柔軟な列操作:**
    -   出力する列の選択
    -   既存の列の値に基づいた新しい列の追加（式評価エンジンを使用）
-   **フィルタリング:** 指定した条件に基づいて行をフィルタリングできます（式評価エンジンを使用）。
-   **出力ファイルの分割:** 出力ファイルを行数で分割できます。
-   **デバッグログ:** デバッグモードで実行すると、処理の詳細なログをファイルに出力できます。
-   **クォートモード:** 出力時のクォートモードを細かく設定できます。

## 使い方

### 設定ファイル (csvsc.json)

設定ファイルはJSON形式で記述します。以下は設定ファイルの例です。

```json:csvsc.json
{
    "input_dir": "./input",
    "input_encoding": "UTF-8",
    "output_encoding": "auto",
    "output_dir": "./output",
    "output_filename": "output.csv",
    "max_rows_per_file": 1000,
    "output_quotechar":"\"",
    "output_quotemode":"all",
    "output_columns": [],
    "add_columns": {
        "column2": "fnc1([column2])",
        "add_column1": "fnc1($[column1])",
        "add_column2": "fnc2(@#,$[column3])"
    },
    "filter_conditions": [
        "@[column1] > 10"
    ],
    "debug": true
}
```
-   `input_dir`: 入力CSV/TSVファイルが格納されているディレクトリ。
-   `input_encoding`: 入力ファイルのエンコーディング。デフォルトはUTF-8。
-   `output_encoding`: 出力ファイルのエンコーディング。`auto`を指定すると入力ファイルのエンコーディングが使用されます。デフォルトは`auto`。
-   `output_dir`: 出力ファイルを保存するディレクトリ。
-   `output_filename`: 出力ファイルの名前。
-   `max_rows_per_file`: 出力ファイルを分割する場合の1ファイルあたりの最大行数。
-   `output_quotechar`: 出力時のクォート文字。デフォルトは`"`。
-   `output_quotemode`: 出力時のクォートモード。`minimal`, `numeric`, `none`, `all`から選択。デフォルトは`all`。
-   `output_columns`: 出力する列の名前のリスト。空の場合はすべての列が出力されます。
-   `add_columns`: 追加する列の名前と、その値を計算する式を定義する辞書。
    -   `@[column_name]`、`$[column_name]` は、指定された列の値を参照します。
    -   `@#`、 `$#` は、現在の行番号を参照します。
    -   式は、列名を実行する行の値に置換し、評価されます。
    -   式は、`fnc1(value)` または `fnc2(value1, value2)` の形式で、関数を呼び出すことができます。
    -   出力する列と同名の列が存在する場合、その列の値が上書きされます。
-   `filter_conditions`: 行をフィルタリングするための条件のリスト。
    -   式は、列名を実行する行の値に置換し、評価されます。評価結果が `true` と判断出来る場合、その行は出力されます。
    -   条件は、`@[column_name] > 10` のように、列名と比較演算子を組み合わせて記述します。
-   `debug`: デバッグモードを有効にするかどうか。`true` または `false`。

### 実行

csvsc.exe を実行すると、設定ファイルを読み込んで処理を実行します。
設定ファイルは `csvsc.json` という名前で、スクリプトと同じディレクトリに配置する必要があります。

## 式評価エンジン

`add_columns` と `filter_conditions` で使用される式は、式評価エンジンによって評価され、その結果が出力されます。

### 使用可能な変数

-   `@[column_name]`: 指定された列の値を数値として参照します。
-   `$[column_name]`: 指定された列の値を、文字列として参照します。
-   `@#`: 現在の行番号を数値として参照します。
-   `$#`: 現在の行番号を文字列として参照します。

### カスタム関数の利用 (`fn` フォルダ)

`fn` フォルダにPythonファイルを配置することで、数式評価時にカスタム関数を利用できます。
例えば、`fn` フォルダに `my_functions.py` というファイルを作成し、その中に `def hello(x): ...` という関数を定義した場合、数式の中で `hello(列名)` のように呼び出すことができます。

`fn` フォルダ内のPythonファイルを更新した場合、`csvsc` を再起動する必要はありません。次回の評価時に自動的に変更が反映されます。

### デバッグログ

デバッグモードを有効にすると、`debug.log` ファイルに詳細なログが出力されます。


## 注意点

-   設定ファイル (`csvsc.json`) がスクリプトと同じディレクトリに存在する必要があります。
-   入力ディレクトリにCSV/TSVファイルが存在しない場合、エラーログが出力されます。
-   出力ディレクトリが存在しない場合は、自動的に作成されます。
-   `add_columns` で指定した式がエラーになった場合、エラーログが出力されます。
-   `filter_conditions` で指定した式が `false` と評価された場合、その行はスキップされます。

## 数式評価ツール

数式評価ツールは、`Csvsc`で使用する数式を評価するためのツールです。
列名と値、式を入力すると、その式を評価して結果を表示します。

### 実行

`数式評価ツール.exe` を実行すると、数式評価ツールが起動します。
`評価` ボタンを押すと、入力された列名と値、式を評価して結果を表示します。
`fn`フォルダに格納したpythonファイルに関数を実装することで、任意の関数を使用できます。
pythonファイルを更新すると、数式評価ツールでは次回の評価時に反映されます。


## 注意点

-   設定ファイル (`csvsc.json`) がスクリプトと同じディレクトリに存在する必要があります。
-   入力ディレクトリにCSV/TSVファイルが存在しない場合、エラーログが出力されます。
-   出力ディレクトリが存在しない場合は、自動的に作成されます。
-   `add_columns` で指定した式がエラーになった場合、エラーログが出力されます。
-   `filter_conditions` で指定した式が `false` と評価された場合、その行はスキップされます。

## 依存関係

### csvsc
-   Python 3.6以上
-   標準ライブラリのみ

### 数式評価ツール
-   Python 3.7以上
-   Flet 1.6.0以上

## ライセンス

MIT License